---
layout: post
title: CVE-2023-21716 취약점 분석
subtitle: Out-of-bounds read vulnerability in adobe
categories: CVE
tags: [cve-2023-21716, MSOffice-RTF]
---
# CVE-2023-21716, RTF 폰트테이블 오류로 발생한 원격실행 취약점

# **소개**

올 해 2월, MS 오피스 워드에서 초고위험도 취약점이 발견되었다. 해당 취약점 코드는 ‘CVE-2023-21716’으로,  취약점을 통해 원격 코드 실행이 가능하다. 시큐레터 기술연구소 NOM@L 은 해당 취약점에 대해 분석 및 대응하였다.

# **취약점 분석**

본 취약점은 조작된 폰트테이블 데이터를 이용하여 메모리 오류를 발생시킨다. 먼저 폰트테이블 데이터 양식을 확인해볼 필요가 있다.

## **RTF Font Table**

![Image1_FontTable.png](/assets/images/cve-2023-21716-img/Image1_FontTable.png "폰트의 고유 번호 및 폰트 이름으로 이루어진 폰트테이블")

## **폰트 테이블 데이터 예시**

{\fonttbl{\f0\fnil\fcharset0굴림;}**{\f1\fnil\fcharset0굴림체;}**}

- fonttbl : 폰트 테이블 명시
- f1 : 폰트 고유번호
- fcharset : 폰트 이름

## **RTF 파일의 제어문자 파싱 흐름**

RTF 파일은 기본적으로 아래와 같은 데이터 처리 과정을 거치면서 실행된다.

**RTF 데이터 블록 메모리 로드 → 제어문자 확인 → 제어문자 처리 로직(분기)실행 → 다음 제어문자 확인 → 제어문자 처리로직(분기) → ..**

아래의 코드가 있는 취약한 함수는 열 개의 폰트 데이터를 처리할 때 한번 호출된다. 즉 “제어문자 확인 → 제어문자 처리 로직(분기)실행”과정에서 한번씩 수행한다는 의미로 폰트테이블이 1000개 있으면 아래의 코드를 100번 호출한다.

```
3161be26 0fbf06          movsx   eax,word ptr [esi]
3161be29 668b4d0c        mov     cx,word ptr [ebp+0Ch]
3161be2d 66894c4604      mov     word ptr [esi+eax*2+4],cx
3161be32 0fbf4e02        movsx   ecx,word ptr [esi+2]
3161be36 0fbf06          movsx   eax,word ptr [esi]
3161be39 03c1            add     eax,ecx
3161be3b 8b4d10          mov     ecx,dword ptr [ebp+10h]
3161be3e 668b09          mov     cx,word ptr [ecx]
3161be41 66894c4604      mov     word ptr [esi+eax*2+4],cx
```

## 취약 지점 **디버깅**

```
eax=0026160c ebx=00000001 ecx=000004e4 edx=ffff7ffc esi=07820048 edi=00008002
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206
**6724cf67 66894c5604      mov     word ptr [esi+edx*2+4],cx ds:0023:07810044=????**
ChildEBP RetAddr  Args to Child
002615ac 67245aa2 004a3144 00007ff8 00261630 wwlib!DllGetLCID+0x2821d
00264824 676c7f3e 004a311c 00264868 0000006d wwlib!DllGetLCID+0x1cb69
00264ab4 6720f21a 0000000b 004a3140 40080000 wwlib!DllGetLCID+0x4a2cb4
0026667c 67261aab 00266fc4 00000001 00000000 wwlib!DllGetClassObject+0x2f72b
00267bbc 67896527 00267ea4 00267e9c 04012000 wwlib!DllGetLCID+0x3e80e
0026a1d8 674145b9 0026a6c8 ffffffff 00000001 wwlib!DllGetLCID+0x3b2a9f
0026d750 66fd4a53 0026d836 0000000a 0026d784 wwlib!DllGetClassObject+0x2c97
0026f800 010b1558 010b0000 00000000 004222a9 winword+0x15c4
0026f8a0 77d637f5 7ffdd000 76fff4c7 00000000 kernel32!BaseThreadInitThunk+0xe
0026f8f8 00000000 010b10d4 7ffdd000 00000000 ntdll!_RtlUserThreadStart+0x1b
```

취약 버전의 wwlib.dll에서 취약점 파일 열람 시 메모리 접근 위반 오류가 발생한 것을 확인할 수 있다.

해당 위치를 디스어셈블러 툴로 확인하면 아래와 같은 기능을 확인할 수 있다.

![Image2_Before_FontTbl_Index.png](/assets/images/cve-2023-21716-img/Image2_Before_FontTbl_Index.png "폰트테이블 인덱스 저장")


![Image3_Before_AppCrash_Point.png](/assets/images/cve-2023-21716-img/Image3_Before_AppCrash_Point.png "오류 발생 지점")


특정 주소를 포함하여 폰트테이블 인덱스를 저장하는 흐름과 오류 발생 지점을 확인할 수 있었다.  분석 결과  발췌한 문서에서 폰트 테이블의 크기 제한 부분을 확인할 수 없었다. 또한 실제 오류가 발생한 지점의 흐름에서도 검사하는 부분이 없는 것으로 보아 **메모리 사용 가능한 크기 검사기능의 부재로 인해 취약점이 발생한 것으로 판단된다.**

## **취약점 유발 인자 분석**

취약점 발생 지점을 파악 후 보다 정확한 취약점 유발 인자를 파악하기 위해 폰트테이블의 데이터를 변경하여 검사를 진행하였다.

![Image_FontDataFormat.png](/assets/images/cve-2023-21716-img/Image_FontDataFormat.png "폰트테이블 데이터 형식")


검사 결과 위의 **모든 데이터 형식에서 취약점이 발생**하였으며 취약점 유발에 주요 사항은 **중복되지 않는 폰트 번호가 얼마나 존재하는지의 유무**임을 확인할 수 있었다.

## **취약점 대응 방안**

**실제 적용된 보안 패치 버전 분석**

```
0:000> kb
00201540 77d468d4 75f11fdb ffffffff c0000417 ntdll!KiFastSystemCallRet
WARNING: Stack unwind information not available. Following frames may be wrong.
00201580 74fcaf9b 00000000 00000000 00000000 MSVCR100!invoke_watson+0x23
002015c0 **6769820b** 0036bf98 00007ff8 00201644 wwlib!DllGetClassObject+0x74ca8
00204838 67693820 0036bf68 0020487c 00000088 wwlib!DllGetClassObject+0x63142
00204ac8 672e8386 0000000b 0036bf94 40280000 wwlib!DllGetClassObject+0x600aa
00206690 671e9d08 00206fd8 00000001 00000000 wwlib!DllGetLCID+0x1a82f0
00207bd0 678914e7 00207eb8 00207eb0 04012000 wwlib!DllGetLCID+0xa4bb8
0020a1ec 673adba0 0020a6dc ffffffff 00000001 wwlib!DllGetLCID+0x42cbb7
0020d764 66fd4c00 0020d84a 0000000a 0020d798 wwlib!FMain+0x3180
0020f814 01391558 01390000 00000000 002f2309 winword+0x15c4
0020f8b4 77d637f5 7ffdc000 77262755 00000000 kernel32!BaseThreadInitThunk+0xe
0020f90c 00000000 013910d4 7ffdc000 00000000 ntdll!_RtlUserThreadStart+0x1b
```

먼저 콜스택을 확인해 보면 예외처리 후 정상적으로 프로세스가 종료(TerminatePorccess)된 것을 확인할 수 있다.

![Image4_Exceptioncall_caller.png](/assets/images/cve-2023-21716-img/Image4_Exceptioncall_caller.png "예외 처리 함수 호출자 함수")

위의 그림은 fonttable 파싱하는 부분으로 취약 버전에서 오류가 발생했던 주소가 존재하는 함수를 디스어셈블러 툴로 확인한 것이다. 함수의 전반적인 부분은 크게 변경되지 않았다.

![Image5_Exceptioncall_Point.png](/assets/images/cve-2023-21716-img/Image5_Exceptioncall_Point.png "예외처리함수 호출 부분")


패치 버전에서는 특정 주소에서 EAX 레지스터에 0xA(10)을 더하고 예외처리 함수를 호출하는 기능이 추가되었다.

![Image6_Exceptioncall.png](/assets/images/cve-2023-21716-img/Image6_Exceptioncall.png "비정상값을 검사, 예외처리를 수행하는 함수")

예외 처리 기능은 비교적 간단하게 되어 있음을 알 수 있다.

0x8000를 더한 값을 EAX 레지스터에 저장하고 EAX 값을 비교하여 0xFFFF보다 크다면 예외 처리하는 방식이 추가되었다. 이는 fonttbl의 인덱스 크기가 0x8000을 초과하는 것을 확인하여 예외처리하는 것으로 판단된다.

**운영상 대응 방안**

사내 이메일 보안 교육 강화

- 출처를 알 수 없는 발신자로부터 전달된 문서 파일 열람 자제

열람 기능 제한

- 사용자가 일반 텍스트 형식으로 이메일 메시지 확인할 것을 권장
- 미리보기 기능 비활성화
- MS 오피스 파일 차단 정책 사용

사내 운영 상황을 고려 후 최신 보안 업데이트 권장

- MS 보안 업데이트 가이드 링크
    - [https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-21716](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-21716)